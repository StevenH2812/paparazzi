<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">

<flight_plan alt="1" ground_alt="0" lat0="51.990634" lon0="4.376789"
	max_dist_from_home="20" name="Steven_bebop2_step_response" security_height="0.4">
	<header>
		#include "autopilot.h"
		#include "subsystems/radio_control.h"
		#include "subsystems/ahrs.h"
		#include "subsystems/electrical.h"
		#include "subsystems/datalink/datalink.h"
	</header>
		<waypoints>
		<waypoint height="0" name="HOME" x="0.0" y="0.0" />
		<waypoint height="2" name="CLIMB" x="1.2" y="-0.6" />
		<waypoint name="GOAL" x="0.0" y="0.0" />
		<waypoint height="1.5" name="STDBY" x="-1.5" y="-1.5" />
		<waypoint lat="51.9906873" lon="4.3768069" name="_DZ1" />
		<waypoint lat="51.9906496" lon="4.3767068" name="_DZ2" />
		<waypoint lat="51.9905876" lon="4.3767679" name="_DZ3" />
		<waypoint lat="51.9906254" lon="4.3768677" name="_DZ4" />
	</waypoints>
	<sectors>
		<sector color="red" name="DangerZone">
			<corner name="_DZ1" />
			<corner name="_DZ2" />
			<corner name="_DZ3" />
			<corner name="_DZ4" />
		</sector>
	</sectors>
	<variables>
		<variable var="vxfp" min="-3" max="3" step="0.1" init="0.5" />
		<variable var="vyfp" min="-3" max="3" step="0.1" init="0.5"/>
		<variable var="heightfp" min="0" max="3" step="0.1" init="1"/>
		<variable var="headingAngle" min="0" max="360" step="5" init="0"/>
	</variables>
	<exceptions>
		<!-- exception cond="datalink_time>=2" deroute="Land"/>
		<exception cond="radio_control.status == RC_REALLY_LOST" deroute="Land"/>
		<exception cond="!InsideDangerZone(GetPosX(), GetPosY())" deroute="Hover guided"/-->
	</exceptions>
	<blocks>
		<block name="FPInit">
      		<while cond="!GpsFixValid()"/>
      		<while cond="1"/>
    	</block>
		<block name="Force Start Engines" strip_button="Takeoff" strip_icon="takeoff.png">
			<call_once fun="guidance_v_set_guided_th(0.2)"/>
     		<call_once fun="autopilot_set_motors_on(TRUE)"/>
        </block>
        <block name="Hover guided">
        	<while cond="TRUE">
        		<call fun="hoverGuided(heightfp)"/>
        	</while>                
        </block>    
        <block name="Set heading">
        	<call fun="setHeadingToDegrees(headingAngle)"/>
        	<deroute block="Hover guided"/>               
        </block>        
        <block name="Fly forward delay">        
        	<while cond="TRUE">
        		<call fun="hoverGuidedStart(heightfp)"/>     
        	</while>        
        	<exception cond="block_time>2" deroute="Fly forward"/>
        </block> 
        <block name="Fly forward">        
        	<while cond="TRUE">
        		<call fun="setBodyForwardVelocity(vxfp, heightfp)"/>     
        	</while>        
        	<exception cond="block_time>4/vxfp" deroute="Hover guided end"/>
        </block> 
        <block name="Fly backward delay">        
        	<while cond="TRUE">
        		<call fun="hoverGuidedStart(heightfp)"/>     
        	</while>        
        	<exception cond="block_time>2" deroute="Fly backward"/>
        </block> 
        <block name="Fly backward">        
        	<while cond="TRUE">
        		<call fun="setBodyForwardVelocity(-vxfp, heightfp)"/>     
        	</while>        
        	<exception cond="block_time>4/vxfp" deroute="Hover guided end"/>
        </block> 
        <block name="Fly right delay">        
        	<while cond="TRUE">
        		<call fun="hoverGuidedStart(heightfp)"/>     
        	</while>        
        	<exception cond="block_time>2" deroute="Fly right"/>
        </block> 
        <block name="Fly right">        
        	<while cond="TRUE">
        		<call fun="setBodyRightVelocity(vyfp, heightfp)"/>     
        	</while>        
        	<exception cond="block_time>4/vyfp" deroute="Hover guided end"/>
        </block> 
        <block name="Fly left delay">        
        	<while cond="TRUE">
        		<call fun="hoverGuidedStart(heightfp)"/>     
        	</while>        
        	<exception cond="block_time>2" deroute="Fly left"/>
        </block> 
        <block name="Fly left">        
        	<while cond="TRUE">
        		<call fun="setBodyRightVelocity(-vyfp, heightfp)"/>     
        	</while>        
        	<exception cond="block_time>4/vyfp" deroute="Hover guided end"/>
        </block> 
        <block name="Hover guided end">
        	<while cond="TRUE">
        		<call fun="hoverGuidedEnd(heightfp)"/>
        	</while>                
        </block>  
		<block name="Land" strip_button="Land Here" strip_icon="land-right.png">
			<call fun="goLand()"/>
      		<while cond="1"/>
		</block>
		<block name="Force Kill Engines">
     		<call_once fun="autopilot_set_motors_on(FALSE)"/>
      		<while cond="1"/>
      	</block>
	</blocks>
</flight_plan>
